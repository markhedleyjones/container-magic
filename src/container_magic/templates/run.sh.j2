#!/usr/bin/env bash
# DO NOT EDIT â€” this file is generated from cm.yaml and will be overwritten.
# To make changes, edit cm.yaml and run: cm update
# Generated by container-magic: https://github.com/markhedleyjones/container-magic

set -euo pipefail

IMAGE_NAME="{{ project_name }}"
TAG="latest"
WORKDIR="{{ workdir }}"
WORKSPACE_NAME="{{ workspace_name }}"
SHELL="{{ shell }}"

# Detect runtime backend
{%- if backend == "auto" %}
if command -v podman >/dev/null 2>&1; then
	RUNTIME="podman"
elif command -v docker >/dev/null 2>&1; then
	RUNTIME="docker"
else
	echo "Error: Neither podman nor docker found in PATH"
	exit 1
fi
{%- else %}
RUNTIME="{{ backend }}"
{%- endif %}

# Check if image exists locally to avoid registry prompts
if ! ${RUNTIME} image inspect "${IMAGE_NAME}:${TAG}" &>/dev/null; then
	echo "Error: Image ${IMAGE_NAME}:${TAG} not found locally"
	echo "Build it with: ./build.sh"
	exit 1
fi

# Build base run arguments (common to all commands)
BASE_RUN_ARGS=("--rm")
BASE_RUN_ARGS+=("--hostname" "${IMAGE_NAME}")
BASE_RUN_ARGS+=("--name" "${IMAGE_NAME}")
{%- if backend == "auto" %}
if [[ "${RUNTIME}" == "podman" ]]; then
	BASE_RUN_ARGS+=("--replace")
fi
{%- elif backend == "podman" %}
BASE_RUN_ARGS+=("--replace")
{%- endif %}
{%- if privileged %}
BASE_RUN_ARGS+=("--privileged")
{%- endif %}
{%- if network %}
BASE_RUN_ARGS+=("--net" "{{ network }}")
{%- endif %}
{%- if volumes %}

# Additional bind mounts
{%- for volume in volumes %}
BASE_RUN_ARGS+=("-v" "{{ volume }}")
{%- endfor %}
{%- endif %}
{%- if devices %}

# Device passthrough
{%- for device in devices %}
BASE_RUN_ARGS+=("--device" "{{ device }}")
{%- endfor %}
{%- endif %}
{%- if features.display %}

# Display support (Wayland and X11)
if [[ -n "${WAYLAND_DISPLAY:-}" ]]; then
	wayland_socket="${XDG_RUNTIME_DIR}/${WAYLAND_DISPLAY}"
	BASE_RUN_ARGS+=("-e" "WAYLAND_DISPLAY")
	BASE_RUN_ARGS+=("-e" "XDG_RUNTIME_DIR=${XDG_RUNTIME_DIR}")
	BASE_RUN_ARGS+=("-v" "${wayland_socket}:${wayland_socket}")
fi
if [[ -n "${DISPLAY:-}" ]]; then
	xsock=/tmp/.X11-unix
	xauth=/tmp/.docker.xauth
	touch "$xauth"
	if [[ -f "$HOME/.Xauthority" ]]; then
		xauth nlist "${DISPLAY}" | sed -e 's/^..../ffff/' | xauth -f "${xauth}" nmerge -
	fi
	BASE_RUN_ARGS+=("-e" "DISPLAY")
	BASE_RUN_ARGS+=("-e" "XAUTHORITY=${xauth}")
	BASE_RUN_ARGS+=("-v" "${xauth}:${xauth}")
	BASE_RUN_ARGS+=("-v" "${xsock}:${xsock}")
	BASE_RUN_ARGS+=("--env" "QT_X11_NO_MITSHM=1")
fi
{%- endif %}
{%- if features.gpu %}

# GPU support
if [[ -d /dev/dri ]]; then
	BASE_RUN_ARGS+=("--device" "/dev/dri:/dev/dri")
fi
if command -v nvidia-smi >/dev/null 2>&1; then
	BASE_RUN_ARGS+=("-e" "NVIDIA_DRIVER_CAPABILITIES=all")
	if [[ "${RUNTIME}" == "docker" ]]; then
		BASE_RUN_ARGS+=("--gpus=all")
	elif [[ "${RUNTIME}" == "podman" ]]; then
		BASE_RUN_ARGS+=("--device" "nvidia.com/gpu=all")
		BASE_RUN_ARGS+=("--annotation=run.oci.keep_original_groups=1")
		BASE_RUN_ARGS+=("--security-opt=label=disable")
	fi
fi
{%- endif %}
{%- if features.audio %}

# Audio support (PulseAudio/PipeWire)
if [[ -S "/run/user/$(id -u)/pulse/native" ]]; then
	BASE_RUN_ARGS+=("-v" "/run/user/$(id -u)/pulse/native:/run/user/$(id -u)/pulse/native")
	BASE_RUN_ARGS+=("-e" "PULSE_SERVER=unix:/run/user/$(id -u)/pulse/native")
fi
{%- endif %}
{%- if features.aws_credentials %}

# AWS credentials
if [[ -d "$HOME/.aws" ]]; then
	BASE_RUN_ARGS+=("-v" "$HOME/.aws:${WORKDIR}/.aws:z")
fi
{%- endif %}

{%- if commands %}

# Custom command handlers
{%- for command_name, command_spec in commands.items() %}

run_{{ command_name }}() {
	{%- if command_spec.standalone %}
	# Delegate to standalone script
	exec "$(dirname "$0")/{{ command_name }}.sh"
	{%- else %}
	{%- if command_spec.description %}
	# {{ command_spec.description }}
	{%- endif %}
	local RUN_ARGS=("${BASE_RUN_ARGS[@]}")

	{%- if command_spec.env %}
	# Environment variables
	{%- for key, value in command_spec.env.items() %}
	RUN_ARGS+=("-e" "{{ key }}={{ value }}")
	{%- endfor %}
	{%- endif %}
	{%- if command_spec.ports %}
	# Port publishing
	{%- for port in command_spec.ports %}
	RUN_ARGS+=("--publish" "{{ port }}")
	{%- endfor %}
	{%- endif %}

	${RUNTIME} run "${RUN_ARGS[@]}" \
		-w "${WORKDIR}" \
		"${IMAGE_NAME}:${TAG}" \
		"${SHELL}" -c "{{ command_spec.command | replace('\"', '\\\"') }}"
	{%- endif %}
}
{%- endfor %}

# Check for custom command
if [ $# -gt 0 ]; then
	case "$1" in
	{%- for command_name in commands.keys() %}
	{{ command_name }})
		shift
		run_{{ command_name }} "$@"
		exit $?
		;;
	{%- endfor %}
	esac
fi
{%- endif %}

# Use base run arguments
RUN_ARGS=("${BASE_RUN_ARGS[@]}")

# Run command or shell
if [ $# -gt 0 ]; then
	# Run specific command (no TTY flags)
	${RUNTIME} run "${RUN_ARGS[@]}" \
		-w "${WORKDIR}/${WORKSPACE_NAME}" \
		"${IMAGE_NAME}:${TAG}" \
		"${SHELL}" -c "$*"
else
	# Interactive shell (add TTY flags only if stdin is a TTY)
	if [[ -t 0 ]]; then
		RUN_ARGS+=("--interactive" "--tty")
	fi
	${RUNTIME} run "${RUN_ARGS[@]}" \
		-w "${WORKDIR}/${WORKSPACE_NAME}" \
		"${IMAGE_NAME}:${TAG}" \
		"${SHELL}"
fi
