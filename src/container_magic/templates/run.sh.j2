#!/usr/bin/env bash
# Standalone production run script
# Generated by container-magic - can be run without container-magic installed

set -euo pipefail

IMAGE_NAME="{{ project_name }}"
TAG="latest"
WORKDIR="{{ workdir }}"
WORKSPACE_NAME="{{ workspace_name }}"
SHELL="{{ shell }}"

# Detect runtime backend
{% if backend == "auto" %}
if command -v podman >/dev/null 2>&1; then
	RUNTIME="podman"
elif command -v docker >/dev/null 2>&1; then
	RUNTIME="docker"
else
	echo "Error: Neither podman nor docker found in PATH"
	exit 1
fi
{% else %}
RUNTIME="{{ backend }}"
{% endif %}

# Build run arguments
RUN_ARGS=(
	"--rm"
	"-it"
	"--hostname" "${IMAGE_NAME}"
	{% if privileged %}
	"--privileged"
	{% endif %}
)

# Check if image exists
if ! ${RUNTIME} image inspect "${IMAGE_NAME}:${TAG}" >/dev/null 2>&1; then
	echo "Error: Image ${IMAGE_NAME}:${TAG} not found"
	echo "Build it first with: ./build.sh"
	exit 1
fi

# Run command or shell
if [ $# -gt 0 ]; then
	# Run specific command
	${RUNTIME} run "${RUN_ARGS[@]}" \
		-w "${WORKDIR}/${WORKSPACE_NAME}" \
		"${IMAGE_NAME}:${TAG}" \
		"${SHELL}" -c "$*"
else
	# Interactive shell
	${RUNTIME} run "${RUN_ARGS[@]}" \
		-w "${WORKDIR}/${WORKSPACE_NAME}" \
		"${IMAGE_NAME}:${TAG}" \
		"${SHELL}"
fi
