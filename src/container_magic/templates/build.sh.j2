#!/usr/bin/env bash
# Standalone production build script
# Generated by container-magic: https://github.com/markhedleyjones/container-magic
# Can be run without container-magic installed

set -euo pipefail

IMAGE_NAME="{{ project_name }}"
TAG="latest"
WORKSPACE_NAME="{{ workspace_name }}"
USER_NAME="{{ production_user }}"
USER_UID="1000"
USER_GID="1000"
PRODUCTION_STAGE="{{ production_stage }}"

# Determine workdir based on user
if [ "${USER_NAME}" = "root" ]; then
	WORKDIR="/root"
else
	WORKDIR="/home/${USER_NAME}"
fi

echo "Building production image: ${IMAGE_NAME}:${TAG}"

docker build \
	--target "${PRODUCTION_STAGE}" \
	--build-arg USER_NAME="${USER_NAME}" \
	--build-arg USER_UID="${USER_UID}" \
	--build-arg USER_GID="${USER_GID}" \
	--build-arg WORKDIR="${WORKDIR}" \
	--build-arg WORKSPACE_NAME="${WORKSPACE_NAME}" \
	--tag "${IMAGE_NAME}:${TAG}" \
	.

echo "Production image built successfully: ${IMAGE_NAME}:${TAG}"
echo "Workspace included in image at: ${WORKDIR}/${WORKSPACE_NAME}"
echo ""
echo "To run the image, use: ./run.sh [command]"
