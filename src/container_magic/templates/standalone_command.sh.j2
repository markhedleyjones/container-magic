#!/usr/bin/env bash
# DO NOT EDIT â€” this file is generated from cm.yaml and will be overwritten.
# To make changes, edit cm.yaml and run: cm update
# Generated by container-magic: https://github.com/markhedleyjones/container-magic
# Command: {{ command_name }}
{% if description -%}
# {{ description }}
{% endif -%}

set -euo pipefail

IMAGE_NAME="{{ project_name }}"
CONTAINER_NAME="{{ project_name }}-{{ command_name }}"
TAG="latest"
WORKDIR="{{ workdir }}"
SHELL="{{ shell }}"

# Detect runtime backend
{% if backend == "auto" -%}
if command -v podman >/dev/null 2>&1; then
	RUNTIME="podman"
elif command -v docker >/dev/null 2>&1; then
	RUNTIME="docker"
else
	echo "Error: Neither podman nor docker found in PATH"
	exit 1
fi
{% else -%}
RUNTIME="{{ backend }}"
{% endif -%}

# Build run arguments
RUN_ARGS=(
	"--rm"
	"--hostname" "${IMAGE_NAME}"
	"--name" "${CONTAINER_NAME}"
{% if privileged -%}
	"--privileged"
{% endif -%}
{% if network -%}
	"--net" "{{ network }}"
{% endif -%}
)
{% if backend == "auto" %}

# Replace existing container with same name (podman)
if [[ "${RUNTIME}" == "podman" ]]; then
	RUN_ARGS+=("--replace")
fi
{% elif backend == "podman" %}

# Replace existing container with same name
RUN_ARGS+=("--replace")
{% endif %}
# Add TTY flags if stdin is a terminal
if [[ -t 0 ]]; then
	RUN_ARGS+=("--interactive" "--tty")
fi

# Mount workspace
RUN_ARGS+=("-v" "$(pwd)/{{ workspace_name }}:${WORKDIR}/{{ workspace_name }}:z")
{% if volumes %}

# Additional bind mounts
{% for volume in volumes -%}
RUN_ARGS+=("-v" "{{ volume }}")
{% endfor -%}
{% endif -%}
{% if devices %}

# Device passthrough
{% for device in devices -%}
RUN_ARGS+=("--device" "{{ device }}")
{% endfor -%}
{% endif -%}
{% if features.display %}

# Display support (Wayland and X11)
XHOST_CLEANUP=false
if [[ -n "${WAYLAND_DISPLAY:-}" ]]; then
	wayland_socket="${XDG_RUNTIME_DIR}/${WAYLAND_DISPLAY}"
	RUN_ARGS+=("-e" "WAYLAND_DISPLAY")
	RUN_ARGS+=("-e" "XDG_RUNTIME_DIR=${XDG_RUNTIME_DIR}")
	RUN_ARGS+=("-v" "${wayland_socket}:${wayland_socket}")
fi
if [[ -n "${DISPLAY:-}" ]]; then
	xsock=/tmp/.X11-unix
{% if backend == "auto" -%}
	if [[ "${RUNTIME}" == "podman" ]]; then
		xauth=/tmp/.docker.xauth
		touch "$xauth"
		if [[ -f "$HOME/.Xauthority" ]]; then
			xauth nlist "${DISPLAY}" | sed -e 's/^..../ffff/' | xauth -f "${xauth}" nmerge -
		fi
		RUN_ARGS+=("-e" "XAUTHORITY=${xauth}")
		RUN_ARGS+=("-v" "${xauth}:${xauth}")
	else
		xhost +local: >/dev/null 2>&1
		XHOST_CLEANUP=true
	fi
{% elif backend == "podman" -%}
	xauth=/tmp/.docker.xauth
	touch "$xauth"
	if [[ -f "$HOME/.Xauthority" ]]; then
		xauth nlist "${DISPLAY}" | sed -e 's/^..../ffff/' | xauth -f "${xauth}" nmerge -
	fi
	RUN_ARGS+=("-e" "XAUTHORITY=${xauth}")
	RUN_ARGS+=("-v" "${xauth}:${xauth}")
{% else -%}
	xhost +local: >/dev/null 2>&1
	XHOST_CLEANUP=true
{% endif -%}
	RUN_ARGS+=("-e" "DISPLAY")
	RUN_ARGS+=("-v" "${xsock}:${xsock}")
	RUN_ARGS+=("--env" "QT_X11_NO_MITSHM=1")
fi
if [[ "${XHOST_CLEANUP}" == true ]]; then
	trap 'xhost -local: >/dev/null 2>&1' EXIT
fi
{% endif -%}
{% if features.gpu %}

# GPU support
if [[ -d /dev/dri ]]; then
	RUN_ARGS+=("--device" "/dev/dri:/dev/dri")
fi
if command -v nvidia-smi >/dev/null 2>&1; then
	RUN_ARGS+=("-e" "NVIDIA_DRIVER_CAPABILITIES=all")
	if [[ "${RUNTIME}" == "docker" ]]; then
		RUN_ARGS+=("--gpus=all")
	elif [[ "${RUNTIME}" == "podman" ]]; then
		RUN_ARGS+=("--device" "nvidia.com/gpu=all")
		RUN_ARGS+=("--annotation=run.oci.keep_original_groups=1")
		RUN_ARGS+=("--security-opt=label=disable")
	fi
fi
{% endif -%}
{% if features.audio %}

# Audio support (PulseAudio/PipeWire)
if [[ -S "/run/user/$(id -u)/pulse/native" ]]; then
	RUN_ARGS+=("-v" "/run/user/$(id -u)/pulse/native:/run/user/$(id -u)/pulse/native")
	RUN_ARGS+=("-e" "PULSE_SERVER=unix:/run/user/$(id -u)/pulse/native")
fi
{% endif -%}
{% if features.aws_credentials %}

# AWS credentials
if [[ -d "$HOME/.aws" ]]; then
	RUN_ARGS+=("-v" "$HOME/.aws:${WORKDIR}/.aws:z")
fi
{% endif -%}

{% if env -%}
# Environment variables
{% for key, value in env.items() -%}
RUN_ARGS+=("-e" "{{ key }}={{ value }}")
{% endfor -%}
{% endif -%}
{% if ports -%}

# Port publishing
{% for port in ports -%}
RUN_ARGS+=("--publish" "{{ port }}")
{% endfor -%}
{% endif -%}

# Check if image exists
if ! ${RUNTIME} image inspect "${IMAGE_NAME}:${TAG}" >/dev/null 2>&1; then
	echo "Error: Image ${IMAGE_NAME}:${TAG} not found"
	echo "Build it first with: ./build.sh"
	exit 1
fi

# Run command
${RUNTIME} run "${RUN_ARGS[@]}" \
	-w "${WORKDIR}" \
	"${IMAGE_NAME}:${TAG}" \
	"${SHELL}" -c "{{ command }}"
