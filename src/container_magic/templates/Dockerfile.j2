# Dockerfile
# Generated by container-magic from container-magic.yaml
# You can edit this file, but changes will be lost on next 'cm update'
# To make permanent changes, edit container-magic.yaml instead

ARG BASE_IMAGE={{ base_image }}
FROM ${BASE_IMAGE} AS base

# Install APT packages
{% if apt_packages %}
RUN apt-get update && \
    apt-get install --yes --no-install-recommends \
{%- for package in apt_packages %}
        {{ package }}{{ " \\" if not loop.last else "" }}
{%- endfor %} && \
    rm -rf /var/lib/apt/lists/*
{% endif %}

# Install Python pip packages
{% if pip_packages %}
RUN pip install --no-cache-dir \
{%- for package in pip_packages %}
        {{ package }}{{ " \\" if not loop.last else "" }}
{%- endfor %}
{% endif %}

# Create user account
ARG USER_GID=1000
ARG USER_UID=1000
ARG USER_NAME={{ production_user }}
RUN if [ "${USER_NAME}" != "root" ]; then \
        groupadd --gid ${USER_GID} ${USER_NAME} && \
        useradd --uid ${USER_UID} --gid ${USER_GID} --create-home ${USER_NAME}; \
    fi

# Setup workspace
ARG WORKDIR=/home/${USER_NAME}
ARG WORKSPACE_NAME={{ workspace_name }}
ENV WORKSPACE=${WORKDIR}/${WORKSPACE_NAME}
WORKDIR ${WORKDIR}

################################################################################
# DEVELOPMENT TARGET - development-friendly image with workspace mounting
################################################################################
FROM base AS development-image
ARG USER_NAME
USER ${USER_NAME}

################################################################################
# PRE-PRODUCTION STAGE - transform workspace into production-ready state
################################################################################
FROM base AS pre-production
ARG USER_NAME
ARG WORKSPACE_NAME
COPY --chown=${USER_NAME} ${WORKSPACE_NAME} ${WORKSPACE}

################################################################################
# PRODUCTION TARGET - final self-contained image
################################################################################
FROM base AS production-image
ARG USER_NAME
COPY --from=pre-production --chown=${USER_NAME} ${WORKSPACE} ${WORKSPACE}
USER ${USER_NAME}
{% if production_entrypoint %}
ENTRYPOINT ["{{ production_entrypoint }}"]
{% endif %}
