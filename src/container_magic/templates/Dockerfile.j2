# Dockerfile
# Generated by container-magic from config file (cm.yaml or container-magic.yaml)
# You can edit this file, but changes will be lost on next 'cm update'
# To make permanent changes, edit your config file instead

{% for stage in stages %}
################################################################################
# Stage: {{ stage.name }}
################################################################################
FROM {{ stage.from }} AS {{ stage.name }}

{% if stage.env_vars %}
# Environment variables
{% for key, value in stage.env_vars.items() %}
ENV {{ key }}={{ value }}
{% endfor %}

{% endif %}
{% for step in stage.ordered_steps %}
{% if step.type == "system_packages" %}
# Install system packages
{% if stage.apt_packages %}
{% if stage.package_manager == "apt" %}
RUN apt-get update && \
    apt-get install --yes --no-install-recommends{% for package in stage.apt_packages %} \
        {{ package }}{% endfor %} && \
    rm -rf /var/lib/apt/lists/*
{% elif stage.package_manager == "apk" %}
RUN apk add --no-cache{% for package in stage.apt_packages %} \
        {{ package }}{% endfor %}
{% elif stage.package_manager == "dnf" %}
RUN dnf install -y{% for package in stage.apt_packages %} \
        {{ package }}{% endfor %} && \
    dnf clean all
{% endif %}
{% endif %}
{% elif step.type == "pip_packages" %}
# Install Python pip packages
{% if stage.pip_packages %}
RUN pip install --no-cache-dir{% for package in stage.pip_packages %} \
        {{ package }}{% endfor %}
{% endif %}
{% elif step.type == "create_user" %}
# Create user account
ARG USER_GID={{ stage.user_gid }}
ARG USER_UID={{ stage.user_uid }}
ARG USER_NAME={{ stage.user }}
ARG USER_HOME={{ stage.user_home }}
{% if stage.user_creation_style == "alpine" %}
RUN if [ "${USER_NAME}" != "root" ]; then \
        addgroup -g ${USER_GID} ${USER_NAME} && \
        adduser -D -u ${USER_UID} -G ${USER_NAME} -h ${USER_HOME} ${USER_NAME}; \
    fi
{% else %}
RUN if [ "${USER_NAME}" != "root" ]; then \
        groupadd --gid ${USER_GID} ${USER_NAME} && \
        useradd --uid ${USER_UID} --gid ${USER_GID} --home-dir ${USER_HOME} --create-home ${USER_NAME}; \
    fi
{% endif %}
{% elif step.type == "switch_user" %}
# Switch to user
USER ${USER_NAME}
{% elif step.type == "switch_root" %}
# Switch to root
USER root
{% elif step.type == "cached_assets" %}
# Copy cached assets
{% for asset in stage.cached_assets %}
COPY {{ asset.source }} {{ asset.dest }}
{% endfor %}
{% elif step.type == "custom" %}
{% if step.command.startswith('COPY ') or step.command.startswith('ADD ') or step.command.startswith('ENV ') or step.command.startswith('WORKDIR ') or step.command.startswith('USER ') or step.command.startswith('LABEL ') or step.command.startswith('EXPOSE ') or step.command.startswith('VOLUME ') or step.command.startswith('RUN ') %}
{{ step.command }}
{% else %}
RUN {{ step.command }}
{% endif %}
{% endif %}
{% endfor %}
{% if stage.ordered_steps %}

{% endif %}
# Setup workspace
ARG WORKDIR=/home/${USER_NAME}
ARG WORKSPACE_NAME={{ workspace_name }}
ENV WORKSPACE=${WORKDIR}/${WORKSPACE_NAME}
WORKDIR ${WORKDIR}
{% endfor %}
